[Unit]
Description=PostgreSQL Server Exporter
Documentation=https://github.com/prometheus-community/postgres-exporter_exporter
Wants=network.target
After=network.target
StartLimitIntervalSec=10

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
RestartSec=10
StartLimitBurst=3
TimeoutStopSec=70
ExecStartPre=/bin/rm --force %t/container-postgres-exporter.pid %t/container-postgres-exporter.ctr-id
ExecStartPre=-/usr/bin/podman pull quay.io/prometheuscommunity/postgres-exporter:{{ postgresexporter_version }}
ExecStart=/usr/bin/podman run \
    --cgroups no-conmon \
    --cidfile %t/container-postgres-exporter.ctr-id \
    --conmon-pidfile %t/container-postgres-exporter.pid \
    --detach \
    --env "DATA_SOURCE_NAME=postgresql://{{ postgres_user }}:{{ postgres_password }}@postgres.service:5432/postgres?sslmode=disable" \
    --hostname %n \
    --log-driver journald \
    --name %n \
    --network "service" \
    --publish "9187:9187/tcp" \
    --pull never \
    --replace \
    --rm \
    prometheuscommunity/postgres-exporter:{{ postgresexporter_version }}

ExecStop=/usr/bin/podman stop --ignore --cidfile %t/container-postgres-exporter.ctr-id --time 10
ExecStopPost=/usr/bin/podman rm --ignore --force --cidfile %t/container-postgres-exporter.ctr-id
PIDFile=%t/container-postgres-exporter.pid
Type=forking

[Install]
WantedBy=multi-user.target default.target

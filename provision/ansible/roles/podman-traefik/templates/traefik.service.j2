[Unit]
Description=traefik
Documentation=https://doc.traefik.io/traefik
Wants=network.target
After=network-online.target
StartLimitIntervalSec=10

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
StartLimitBurst=3
TimeoutStopSec=70
ExecStartPre=/bin/rm --force %t/container-traefik.pid %t/container-traefik.ctr-id
ExecStartPre=-/usr/bin/podman pull docker.io/library/traefik:{{ traefik_version }}
ExecStart=/usr/bin/podman run \
    --cidfile %t/container-traefik.ctr-id \
    --conmon-pidfile %t/container-traefik.pid \
    --cgroups=no-conmon \
    --detach \
    --hostname "canyon.labnet" \
    #--label "cloudflare.enabled=true" \
    #--label "cloudflare.name=ingress" \
    #--label "cloudflare.zone=ffm.ninja" \
    --name %n \
    --network labnet \
    #--publish "443:443" \
    --publish "80:80" \
    --publish "8080:8080" \
    --replace \
    --rm \
    --security-opt label=disable \
    #--volume "{{ traefik_basedir }}/letsencrypt:/letsencrypt" \
    --volume /var/run/podman/podman.sock:/var/run/docker.sock:ro \
    traefik \
    --log.level=DEBUG \
    --api.insecure=true \
    --providers.docker=true \
    --providers.docker.exposedbydefault=false \
    #--entrypoints.websecure.address=:443 \
    #--certificatesresolvers.myresolver.acme.tlschallenge=true \
    #--certificatesresolvers.myresolver.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory \
    #--certificatesresolvers.myresolver.acme.email={{ letsencrypt_email_address }} \
    #--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json

ExecStop=/usr/bin/podman stop --ignore --cidfile %t/container-traefik.ctr-id --time 10
ExecStopPost=/usr/bin/podman rm --ignore --force --cidfile %t/container-traefik.ctr-id
PIDFile=%t/container-traefik.pid
Type=forking

[Install]
WantedBy=multi-user.target default.target
